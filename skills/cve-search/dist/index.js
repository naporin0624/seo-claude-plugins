#!/usr/bin/env node
//#region src/cli.ts
function parseArgs(args) {
	const options = {
		keyword: null,
		cveId: null,
		cweId: null,
		severity: null,
		days: null,
		limit: 10,
		apiKey: null,
		json: false
	};
	for (let i = 0; i < args.length; i++) {
		const arg = args[i];
		switch (arg) {
			case "--keyword":
			case "-k":
				options.keyword = args[++i] || null;
				break;
			case "--cve":
				options.cveId = args[++i] || null;
				break;
			case "--cwe":
				options.cweId = args[++i] || null;
				break;
			case "--severity":
			case "-s": {
				const sev = args[++i]?.toUpperCase();
				if (sev && [
					"CRITICAL",
					"HIGH",
					"MEDIUM",
					"LOW"
				].includes(sev)) options.severity = sev;
				break;
			}
			case "--days":
			case "-d": {
				const days = parseInt(args[++i], 10);
				if (!isNaN(days) && days > 0) options.days = days;
				break;
			}
			case "--limit":
			case "-l": {
				const limit = parseInt(args[++i], 10);
				if (!isNaN(limit) && limit > 0) options.limit = limit;
				break;
			}
			case "--api-key":
				options.apiKey = args[++i] || null;
				break;
			case "--json":
				options.json = true;
				break;
			case "--help":
			case "-h":
				printUsage();
				return null;
		}
	}
	return options;
}
function validateOptions(options) {
	if (!options.keyword && !options.cveId && !options.cweId) return "At least one of --keyword, --cve, or --cwe is required";
	return null;
}
function printUsage() {
	console.log(`
CVE Search - NVD API 2.0 Client

Usage:
  npx cve-search [options]

Options:
  --keyword, -k <term>    Search by keyword (software name, vendor)
  --cve <id>              Search by specific CVE ID (e.g., CVE-2021-44228)
  --cwe <id>              Filter by CWE ID (e.g., CWE-79)
  --severity, -s <level>  Filter by severity (CRITICAL, HIGH, MEDIUM, LOW)
  --days, -d <n>          Published in last N days
  --limit, -l <n>         Max results (default: 10)
  --api-key <key>         NVD API key (or set NVD_API_KEY env var)
  --json                  Output as JSON
  --help, -h              Show this help

Examples:
  npx cve-search --keyword "jquery"
  npx cve-search --cve "CVE-2021-44228"
  npx cve-search --cwe "CWE-89" --severity "CRITICAL"
  npx cve-search --keyword "apache" --days 30
  npx cve-search --keyword "react" --json
`);
}

//#endregion
//#region src/api.ts
const NVD_API_BASE = "https://services.nvd.nist.gov/rest/json/cves/2.0";
var NVDClient = class {
	apiKey;
	constructor(apiKey = null) {
		this.apiKey = apiKey || process.env.NVD_API_KEY || null;
	}
	async search(options) {
		const params = new URLSearchParams();
		if (options.keyword) params.set("keywordSearch", options.keyword);
		if (options.cveId) params.set("cveId", options.cveId);
		if (options.cweId) {
			const cweId = options.cweId.replace(/^CWE-/i, "");
			params.set("cweId", `CWE-${cweId}`);
		}
		if (options.severity) params.set("cvssV3Severity", options.severity);
		if (options.days) {
			const endDate = new Date();
			const startDate = new Date();
			startDate.setDate(startDate.getDate() - options.days);
			params.set("pubStartDate", startDate.toISOString());
			params.set("pubEndDate", endDate.toISOString());
		}
		params.set("resultsPerPage", String(options.limit));
		const url = `${NVD_API_BASE}?${params.toString()}`;
		const headers = { Accept: "application/json" };
		if (this.apiKey) headers.apiKey = this.apiKey;
		try {
			const response = await fetch(url, { headers });
			if (!response.ok) {
				if (response.status === 403) throw new Error("Rate limit exceeded. Wait 30 seconds and try again.");
				throw new Error(`API error: ${response.status} ${response.statusText}`);
			}
			return await response.json();
		} catch (error) {
			if (error instanceof Error && error.message.includes("fetch")) throw new Error("Network error. Check your internet connection.");
			throw error;
		}
	}
};
function getBountyEstimate(severity) {
	const estimates = {
		CRITICAL: "$5,000 - $50,000+",
		HIGH: "$2,000 - $10,000",
		MEDIUM: "$500 - $3,000",
		LOW: "$100 - $500",
		UNKNOWN: "Varies"
	};
	return estimates[severity];
}

//#endregion
//#region src/formatter.ts
const SEVERITY_ORDER = {
	CRITICAL: 0,
	HIGH: 1,
	MEDIUM: 2,
	LOW: 3,
	UNKNOWN: 4
};
function formatCVE(vuln) {
	const cve = vuln.cve;
	const descObj = cve.descriptions?.find((d) => d.lang === "en");
	const description = descObj?.value || "No description available";
	const cvssV31 = cve.metrics?.cvssMetricV31?.[0];
	const cvssV30 = cve.metrics?.cvssMetricV30?.[0];
	const cvss = cvssV31 || cvssV30;
	const severity = cvss?.cvssData?.baseSeverity || "UNKNOWN";
	const score = cvss?.cvssData?.baseScore ?? "N/A";
	const attackVector = cvss?.cvssData?.attackVector || "UNKNOWN";
	const attackComplexity = cvss?.cvssData?.attackComplexity || "UNKNOWN";
	const privilegesRequired = cvss?.cvssData?.privilegesRequired || "UNKNOWN";
	const userInteraction = cvss?.cvssData?.userInteraction || "UNKNOWN";
	const cwes = cve.weaknesses?.flatMap((w) => w.description?.filter((d) => d.lang === "en").map((d) => d.value)).filter((v) => Boolean(v)) || [];
	const references = cve.references?.slice(0, 5).map((r) => r.url) || [];
	const hasExploit = cve.references?.some((r) => r.tags?.some((t) => t.toLowerCase().includes("exploit"))) || false;
	return {
		id: cve.id,
		description: description.substring(0, 500) + (description.length > 500 ? "..." : ""),
		severity,
		score,
		bountyEstimate: getBountyEstimate(severity),
		attackVector,
		attackComplexity,
		privilegesRequired,
		userInteraction,
		cwes,
		references,
		hasExploit,
		published: cve.published,
		lastModified: cve.lastModified
	};
}
function sortBySeverity(cves) {
	return [...cves].sort((a, b) => (SEVERITY_ORDER[a.severity] ?? 4) - (SEVERITY_ORDER[b.severity] ?? 4));
}
function getSummary(cves, totalResults) {
	return {
		total: totalResults,
		shown: cves.length,
		critical: cves.filter((c) => c.severity === "CRITICAL").length,
		high: cves.filter((c) => c.severity === "HIGH").length,
		withExploit: cves.filter((c) => c.hasExploit).length
	};
}
function formatTextReport(cves, summary) {
	const lines = [];
	lines.push("# CVE Search Results\n");
	lines.push(`Found ${summary.total} total results (showing ${summary.shown})\n`);
	for (const cve of cves) lines.push(formatSingleCVE(cve));
	lines.push("\n## Summary");
	lines.push(`- Critical: ${summary.critical}`);
	lines.push(`- High: ${summary.high}`);
	lines.push(`- With known exploits: ${summary.withExploit}`);
	if (summary.critical > 0 || summary.high > 0 && summary.withExploit > 0) lines.push("\nHigh bounty potential detected!");
	return lines.join("\n");
}
function formatSingleCVE(cve) {
	const lines = [];
	lines.push(`\n### ${cve.id}`);
	lines.push("");
	lines.push(`**Severity**: ${cve.severity} (${cve.score})`);
	lines.push(`**Bounty Estimate**: ${cve.bountyEstimate}`);
	lines.push("");
	lines.push("**Description**:");
	lines.push(cve.description);
	lines.push("");
	lines.push("**Attack Vector**:");
	lines.push(`- Vector: ${cve.attackVector}`);
	lines.push(`- Complexity: ${cve.attackComplexity}`);
	lines.push(`- Privileges Required: ${cve.privilegesRequired}`);
	lines.push(`- User Interaction: ${cve.userInteraction}`);
	lines.push("");
	lines.push(`**CWE**: ${cve.cwes.length > 0 ? cve.cwes.join(", ") : "Not specified"}`);
	lines.push("");
	lines.push(`**Exploit Available**: ${cve.hasExploit ? "Yes" : "Unknown"}`);
	lines.push("");
	lines.push("**References**:");
	for (const ref of cve.references) lines.push(`- ${ref}`);
	lines.push("");
	lines.push(`**Published**: ${new Date(cve.published).toLocaleDateString()}`);
	lines.push("---");
	return lines.join("\n");
}

//#endregion
//#region src/index.ts
async function main() {
	const args = process.argv.slice(2);
	if (args.length === 0 || args.includes("--help") || args.includes("-h")) {
		parseArgs(["--help"]);
		process.exit(0);
	}
	const options = parseArgs(args);
	if (!options) process.exit(0);
	const validationError = validateOptions(options);
	if (validationError) {
		console.error(`Error: ${validationError}`);
		process.exit(1);
	}
	console.error("Searching NVD...");
	try {
		const client = new NVDClient(options.apiKey);
		const result = await client.search(options);
		if (!result.vulnerabilities || result.vulnerabilities.length === 0) {
			console.log("No CVEs found matching your criteria.");
			process.exit(0);
		}
		const cves = result.vulnerabilities.map(formatCVE);
		const sortedCves = sortBySeverity(cves);
		const summary = getSummary(sortedCves, result.totalResults);
		if (options.json) console.log(JSON.stringify({
			summary,
			vulnerabilities: sortedCves
		}, null, 2));
		else console.log(formatTextReport(sortedCves, summary));
		if (summary.critical > 0) process.exit(1);
	} catch (error) {
		console.error(`Error: ${error instanceof Error ? error.message : error}`);
		process.exit(1);
	}
}
main();

//#endregion
export { NVDClient, formatCVE, formatTextReport, getSummary, sortBySeverity };
//# sourceMappingURL=index.js.map